#!/usr/bin/env bash
set -euo pipefail

BIN_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
ACTIONS_DIR="$BIN_DIR/actions"

INPUT="/tmp/menu.sh.$$"
trap "rm -f $INPUT" EXIT

# --- Déclaration dynamique du menu : clé = label, valeur = nom_fonction ou script ---

declare -A MENU_ACTIONS=(
    ["Information système graphique"]="action_info_systeme"
    ["Test du moniteur"]="action_test_moniteur"
    ["Relevé RAM"]="action_releve_ram"
    ["Relevé CPU"]="action_releve_cpu"
    ["Relevé batterie"]="action_releve_batterie"
    ["Relevé réseau"]="action_releve_reseau"
    ["Santé disque"]="action_sante_disque"
    ["Infos disque"]="action_info_disque"
    ["Infos carte graphique"]="action_info_gpu"
    ["Stress test du CPU"]="action_stress_cpu"
    ["Test des ports USB"]="action_test_usb"
    ["Test son"]="action_test_son"
    ["Test micro"]="action_test_micro"
    ["Test webcam"]="action_test_webcam"
    ["Test clavier"]="action_test_clavier"
    ["Test connexion internet"]="action_test_connexion_internet"
    ["Réinstaller logiciels"]="action_reinstall_softs"
    ["MAJ du système"]="action_maj_system"
    ["Quit"]="action_quit"
)

# --- Génération du menu dialog automatiquement ---
function display_menu() {
    local menu_items=()
    for label in "${!MENU_ACTIONS[@]}"; do
        menu_items+=("$label" "")
    done
    dialog --clear --help-button --backtitle "Maintenance" \
        --title "Menu principal" \
        --menu "Choisissez une action :" 22 80 20 \
        "${menu_items[@]}" 2>"$INPUT"
    menuitem=$(<"$INPUT")
}

# --- Dispatch générique ---
function dispatch_action() {
    local action="${MENU_ACTIONS[$1]}"
    if [[ -z "$action" ]]; then
        echo "[ERREUR] Action inconnue : $1" >&2
        return 1
    fi
    # Si la fonction existe localement, l'appeler
    if declare -f "$action" > /dev/null; then
        "$action"
    # Sinon, si un script du même nom existe dans actions/, l’exécuter
    elif [[ -x "$ACTIONS_DIR/$action.sh" ]]; then
        "$ACTIONS_DIR/$action.sh"
    else
        echo "[ERREUR] Action $1 non implémentée" >&2
        sleep 2
    fi
}

# --- Boucle principale ---
while true; do
    display_menu
    dispatch_action "$menuitem"
    [[ "$menuitem" == "Quit" ]] && break
done

# --- Exemples d’actions natives ---
action_quit()  { echo "Bye"; }
action_info_systeme() { lshw | less; }
action_test_moniteur() { echo "Test moniteur..."; sleep 1; }
# etc. (déplace-les dans actions/ ou complète ici)
